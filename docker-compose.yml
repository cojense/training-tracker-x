services:
  backend:
    build:
      context: ./training-tracker
      target: development
    environment:
      - FLASK_ENV=development
      - FLASK_APP=trainingbackend.tracker
      - APP_SECRET=dev-secret-change-in-production
      - SQLITE_WAL=false
      - CONNECT_STRING=sqlite:////opt/trainingtracker/db/training.db
      - BACKEND_PORT=5001
      - CORS_ALLOWED_ORIGINS=http://localhost:8080
    ports:
      - "5001:5001"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5001/"]
      interval: 30s
      timeout: 3s
      retries: 3
    volumes:
      - ./training-tracker/db:/opt/trainingtracker/db
      - ./training-tracker/trainingbackend:/opt/trainingtracker/trainingbackend
      - ./training-tracker/sql:/opt/trainingtracker/sql
    command:
      - sh
      - -c
      - |
        set -e
        DB_DIR="/opt/trainingtracker/db"
        DB_FILE="$$DB_DIR/training.db"
        if [ ! -f "$$DB_FILE" ] || [ ! -s "$$DB_FILE" ]; then
          echo "Initializing database at $$DB_FILE..."
          mkdir -p "$$DB_DIR"
          sqlite3 "$$DB_FILE" < /opt/trainingtracker/sql/create_db.sql
          sqlite3 "$$DB_FILE" < /opt/trainingtracker/sql/feb_2021_schema_update.sql
          sqlite3 "$$DB_FILE" < /opt/trainingtracker/sql/nov_2022_schema_update.sql
          sqlite3 "$$DB_FILE" < /opt/trainingtracker/sql/march_2024_schema_update.sql
          sqlite3 "$$DB_FILE" < /opt/trainingtracker/sql/populate_db.sql
          sqlite3 "$$DB_FILE" < /opt/trainingtracker/sql/load_sample_data.sql
          sqlite3 "$$DB_FILE" < /opt/trainingtracker/sql/comprehensive_seed.sql
          echo "Database initialized successfully."
        fi
        exec flask run --host=0.0.0.0 --port=5001 --debug --reload

  frontend:
    build:
      context: ./training-tracker-gui
      target: development
      args:
        - VITE_API_BASE_URL=http://localhost:5001/api
    environment:
      - VITE_API_BASE_URL=http://localhost:5001/api
    ports:
      - "8080:5173"
    volumes:
      - ./training-tracker-gui/src:/app/src
      - ./training-tracker-gui/public:/app/public
      - ./training-tracker-gui/index.html:/app/index.html
      - ./training-tracker-gui/vite.config.ts:/app/vite.config.ts
    depends_on:
      - backend
